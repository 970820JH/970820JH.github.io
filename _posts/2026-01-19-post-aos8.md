---
title: "모바일(AOS)진단 8 - 단말 취약점 진단 (코드패치와 앱 무결성 검증)"
categories:
  - 모바일(AOS)
tags:
  - 모바일(AOS)
---

>   **코드 패치와 앱 무결성 검증 상세 내용 및 취약점** <br>

**> 사전 앱 추출 및 디컴파일, 리패키징 관련 내용은 해당 포스트 URL 참고**<br>
https://970820jh.github.io/%EB%AA%A8%EB%B0%94%EC%9D%BC(aos)/post-aos3/
<br>

*리패키징 이후 디폴트 파일<br>
 ├─ AndroidManifest.xml : 앱 구조, 권한, 컴포넌트<br>
 ├─ apktool.yml : apktool이 자동 생성<br>
 ├─ res/ : 레이아웃, 이미지, 문자열<br>
 ├─ assets/ : 앱이 직접 사용하는 파일<br>
 ├─ original/ : 재패키징용 원본<br>
 ├─ smali/ : 실제 앱 로직<br>
 ├─ smali_classes2/	: 멀티덱스(앱이 커서 dex가 2개 이상)<br>
 ├─ lib/ : NDK 네이티브 라이브러리(.so파일)<br>
 └─ unknown/ : 정확히 분류 못한 파일들<br>

Jadx와 같은 디컴파일 도구는 앱의 실제 동작은 바뀌지 않고, 달빅 코드 패치는 앱의 실제 실행 흐름을 바꾸기 위해서 수정

```
디컴파일을 통한 변조 포인트 클래스를 인지하고 -> 코드 패치 (변조포인트 캐치가 포인트)
* smali 코드 수정
const/4 v1, 0        // v1 = 0
const/4 v2, 1        // v2 = 1 

if-gt v0, v1, :cond_positive    // v0, v1 비교하여 v0가 더 큰 경우 :cond_positive 라벨이 붙은 라인으로 이동
sub-int/2addr v0, v1            // 조건이 거짓일 때
goto :end                       // 조건 분기 이후 공통 종료 지점으로 이동

:cond_positive                  //:cond_positive 라벨
add-int/2addr v0, v2            // v0 + v2 

:end
return v0


* 어셈블리 코드 수정(NDK:Android Native Development Kit, 안드로이드 앱에서 C/C+같은 네이티브 코드를 사용할 수 있게 해주는 개발 도구 모음) - Native계층
cf. NDK사용이유: Java보다 빠른 처리(암호화,게임엔진), 기존 C/C++ 코드 재사용

-> JNI함수 구현 시(C/C++) : Java_패키지명_클래스명_메서드명 식으로 작성해야함
JNIEXPORT jboolean JNICALL
Java_com_example_jni_NativeUtil_isRooted(
        JNIEnv *env,
        jobject thiz) 

CMakeLists.txt 작성하면 APK안의 lib경로 .so 세팅됨 

-> Java쪽 코드
static {
    System.loadLibrary("native-lib");
}
```

>   **보안대책** <br>

앱 실행 시점에 서명키를 확인하는 코드를 구현함으로써, 앱 위변조 검증하도록 조치

```

*앱의 서명을 추출하여 서버에서 검증하는 코드
Public static void checkAppSignatureInServer(Context context, Callback callback)
     try{
            SuppressLint("PackageManagerGetSignatures")
            PackageInfo packageInfo = context.getPackageManager().                  // context.getpackageName() : 현재 앱의 패키지명
    getPackageInfo(context.getPackageName(), PackageManager.GET_SIGNATURES);        // packageManager.GET_SIGNATURES : 앱 서명 정보 포함 요청
            Signature signature = packageInfo.signatures[0];                        // 앱에 포함된 서명 배열 중 첫 번째 서명 추출
            final String currentSignature = obtainSignatureString(signature);       // 서명 객체를 문자열 형태로 변환
            fetchServer(CurrentSign, callback);                                     // 정상 서명 여부(위변조)를 검증 요청
        }catch(PackageManager.NameNotFoundException | NoSuchAlgorithmException e){        // 패키지 정보 조회 실패 또는 서명 해시 알고리즘 오류 발생 시 예외처리
            e.printStackTrace();
        }
```

또는 앱의 소스코드가 변조되는 경우 앱 전체 해시값이 변경되는 점을 이용하여 서버에 저장된 해시값과 비교


```

*앱 전체 해시 검증 코드 
String appPath = null;                  // APK 파일 경로를 저장할 변수
int numBytes;                           
PackageInfo packageInfo = packageInfo = this.getPackageManager().              
    getPackageInfo(this.getPackageName(), PackageManager.GET_META_DATA);        // 현재 앱의 패키지 정보를 조회
appPath = packageInfo.applicationInfo.sourceDir;            // 설치된 APK파일의 실제 경로
FileInputStream is = new FileInputStream(appPath);           // APK파일을 읽기 위한 입력 스트림 생성
MessageDigest md = MessageDigest.getInstance("MD5");        //  MD5 해시 알고리즘 객체 생성
md.reset();                                                 // 이전 해시 상태 초기화
byte[] bytes = new byte[2048];                              // APK파일을 일정 크기씩 읽기 위한 버퍼
while ((numBytes = is.read(bytes)) != -1){                  // APK파일을 끝까지 읽으면서 해시 업데이트
    md.update(bytes, 0, numBytes);                          // 읽은 데이터만큼 해시 계산에 반영
}
byte[] digest = md.digest();                                                   // APK전체 파일에 대한 최종 해시 값 계산
StringBuffer sb = new StringBuffer();                                          // 해시 값을 문자열 형태로 변환하기 위한 stringBuffer
for(int = 0; i < digest.length; i++){                                          // 바이트 배열을 2자리 16진수 문자열로 변환
    sb.append(Integer.toString((digest[i]&0xff) + 0x100, 16).substring(1));    //바이트 배열을 2자리 16진수 문자열로 변환
}
hash = sb.toString();           // 최종 APK 해시 문자열 (MD5)
```

혹은 앱의 코드를 난독화하여 디컴파일 및 변조를 어렵게 하도록 조치
→ 난독화란 분석에 용이한 함수 심볼을 제거하거나 분석이 오래 걸리도록 하는 더미 코드 삽입하는 기법 (직접 구현하는 것은 어렵기에 난독화 솔루션을 사용하여 개발이 완료된 앱파일에 덮어써서 작업)