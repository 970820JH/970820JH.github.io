---
title: "모바일(AOS)진단 8 - 단말 취약점 진단 (코드패치와 앱 무결성 검증)"
categories:
  - 모바일(AOS)
tags:
  - 모바일(AOS)
---

>   **코드 패치와 앱 무결성 검증 상세 내용 및 취약점** <br>

**> 사전 앱 추출 및 디컴파일, 리패키징 관련 내용은 해당 포스트 URL 참고**<br>
https://970820jh.github.io/%EB%AA%A8%EB%B0%94%EC%9D%BC(aos)/post-aos3/
<br>

*리패키징 이후 디폴트 파일<br>
 ├─ AndroidManifest.xml : 앱 구조, 권한, 컴포넌트<br>
 ├─ apktool.yml : apktool이 자동 생성<br>
 ├─ res/ : 레이아웃, 이미지, 문자열<br>
 ├─ assets/ : 앱이 직접 사용하는 파일<br>
 ├─ original/ : 재패키징용 원본<br>
 ├─ smali/ : 실제 앱 로직<br>
 ├─ smali_classes2/	: 멀티덱스(앱이 커서 dex가 2개 이상)<br>
 ├─ lib/ : NDK 네이티브 라이브러리(.so파일)<br>
 └─ unknown/ : 정확히 분류 못한 파일들<br>

Jadx와 같은 디컴파일 도구는 앱의 실제 동작은 바뀌지 않고, 달빅 코드 패치는 앱의 실제 실행 흐름을 바꾸기 위해서 수정

```
디컴파일을 통한 변조 포인트 클래스를 인지하고 -> 코드 패치 (변조포인트 캐치가 포인트)
* smali 코드 수정
const/4 v1, 0        // v1 = 0
const/4 v2, 1        // v2 = 1 

if-gt v0, v1, :cond_positive    // v0, v1 비교하여 v0가 더 큰 경우 :cond_positive 라벨이 붙은 라인으로 이동
sub-int/2addr v0, v1            // 조건이 거짓일 때
goto :end                       // 조건 분기 이후 공통 종료 지점으로 이동

:cond_positive                  //:cond_positive 라벨
add-int/2addr v0, v2            // v0 + v2 

:end
return v0


* 어셈블리 코드 수정(NDK:Android Native Development Kit, 안드로이드 앱에서 C/C+같은 네이티브 코드를 사용할 수 있게 해주는 개발 도구 모음) - Native계층
cf. NDK사용이유: Java보다 빠른 처리(암호화,게임엔진), 기존 C/C++ 코드 재사용

-> JNI함수 구현 시(C/C++) : Java_패키지명_클래스명_메서드명 식으로 작성해야함
JNIEXPORT jboolean JNICALL
Java_com_example_jni_NativeUtil_isRooted(
        JNIEnv *env,
        jobject thiz) 

CMakeLists.txt 작성하면 APK안의 lib경로 .so 세팅됨 

-> Java쪽 코드
static {
    System.loadLibrary("native-lib");
}
```

>   **보안대책** <br>
