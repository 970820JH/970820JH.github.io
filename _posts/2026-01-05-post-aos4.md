---
title: "모바일(AOS)진단 4 - 단말 취약점 진단 1 - "
categories:
  - 모바일(AOS)
tags:
  - 모바일(AOS)
---

>   **앱별 저장소 (안드로이드 디바이스 디렉터리 구조)** <br>

내부 저장소(Internal Storage)와 외부 저장소(External Storage)로 구분<br>
<br>
내부 저장소(Internal Storage) → /data/data
<br>
**/data/data/[패키지명]/cache**: 앱의 캐시 파일, 임시 파일이나 빠른 데이터 접근을 위한 캐시 파일<br>
**/data/data/[패키지명]/databases** : 데이터베이스 관련 내장형 SQLite<br>
**/data/data/[패키지명]/files** : 앱이 생성한 파일, 사용자가 생성한 파일이나 다운로드한 파일, 앱 설정<br>
**/data/data/[패키지명]/lib** : 앱의 네이티브 코드 라이브러리<br>
**/data/data/[패키지명]/shared_prefs** : 앱의 설정이나 사용자 데이터, 상태 정보(사용자 세션 상태나 로그인정보/자동 로그인) 저장, XML파일로 키-값으로 이뤄짐<br>
**/data/data/[패키지명]/app_webview** : 웹뷰(웹페이지HTML로 구성) -> 웹뷰 앱이란 앱이 내부적으로 브라우저를 띄워 웹 페이지를 실행하는 구조<br>

<img src="/assets/images/icon/directory.png"  style="display:block; margin:0 auto; width:90%; border:1px solid #000;"><br>

``
*취약한 예시 (문자열 평문으로 그대로 저장)
SharedPreferences prefs =
    getSharedPreferences("user_prefs", MODE_PRIVATE);   // /data/data/패키지명/shared_prefs/user_prefs.xml

prefs.edit()                                            //SharedPreferences는 읽기 전용, edit()을 호출해서 쓰기 모드
     .putString("token", accessToken)                   // 평문 저장 노출
     .putString("userId", userId)
     .apply();
``

``
*조치 암호화 관련
＊EncryptedSharedPreferences클래스     // Android Keystors는 내부적으로 안드로이드 키스토어(키를 OS가 관리) 사용함 (키스토어 내부적으로 자동 사용/개발자가 api 직접 호출x)

MasterKey masterKey = new MasterKey.Builder(context)
    .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)     // AES-256-GCM방식으로 암호 키 생성
    .build();                                         // 키는 안드로이드 키스토어에 저장

SharedPreferences securePrefs =
    EncryptedSharedPreferences.create(                // 보안 라이브러리가 제공하는 함수
        context,                                      // 저장소를 사용하는 앱 식별 정보
        "secure_prefs",                               // 저장 파일 이름
        masterKey,                                    
        EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,   // 키 자체도 암호화
        EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM  //  value(실제 데이터) 암호화 방식
    );

securePrefs.edit()
    .putString("token", accessToken)   // 실제파일에는 둘 다 암호화된 상태로 저장
    .apply();


*Android Keystore // 키스토어 직접 사용 (키스토어를 직접 제어)
KeyStore keyStore = KeyStore.getInstance("AndroidKeyStore");
keyStore.load(null);


*SQLCipher (DB 암호화)
SQLiteDatabase db =
  SQLiteDatabase.openOrCreateDatabase(
    dbFile,
    "dbPassword",
    null
  );


Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");


``